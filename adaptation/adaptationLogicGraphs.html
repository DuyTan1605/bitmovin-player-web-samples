<!DOCTYPE html>
<!--
*
* Copyright (C) 2016, bitmovin GmbH, All Rights Reserved
*
* Created on: 2016-03-01 11:39:27
* Author:     bitmovin GmbH <dash-player@bitmovin.net>
*
* This source code and its use and distribution, is subject to the terms
* and conditions of the applicable license agreement.
*
-->
<html lang="en">
<head>
    <title>Bitmovin Demo</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet">
    <link rel="icon" type="../image/png" href="../images/bit-fav.png">
    <!-- Bitmovin Player -->
    <script type="text/javascript"
            src="//bitmovin-a.akamaihd.net/bitmovin-player/stable/7.1/bitmovinplayer.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Open Sans', sans-serif;
        color: #fff;
        font-weight: 300;
    }

    body {
        background: rgba(44, 131, 185, 1);
        background: -moz-linear-gradient(left, rgba(44, 131, 185, 1) 0%, rgba(30, 171, 227, 1) 100%);
        background: -webkit-gradient(left top, right top, color-stop(0%, rgba(44, 131, 185, 1)), color-stop(100%, rgba(30, 171, 227, 1)));
        background: -webkit-linear-gradient(left, rgba(44, 131, 185, 1) 0%, rgba(30, 171, 227, 1) 100%);
        background: -o-linear-gradient(left, rgba(44, 131, 185, 1) 0%, rgba(30, 171, 227, 1) 100%);
        background: -ms-linear-gradient(left, rgba(44, 131, 185, 1) 0%, rgba(30, 171, 227, 1) 100%);
        background: linear-gradient(to right, rgba(44, 131, 185, 1) 0%, rgba(30, 171, 227, 1) 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#2c83b9', endColorstr='#1eabe3', GradientType=1);
    }

    #wrapper {
        background: url(../images/logo-bg-demopage.png);
        height: 100vh;
    }

    #banner {
        border-bottom: 1px solid #fff;
        background-color: #1eabe3;
        width: 100%
    }

    #banner h1 {
        margin: 0;
        padding: 30px;
    }

    .logo {
        padding: 10px;
        width: 25%;
        min-width: 350px;
        float: left;
        margin: auto;
    }

    .title {
        width: 75%;
        white-space: nowrap;
    }

    .clear {
        clear: both;
    }

    .content {
        margin-bottom: 10em;
    }

    h1, h2, h3, p {
        font-weight: 300;
        text-align: center;
        margin: 40px;
    }

    #webserver-warning {
        border: 1px solid #fff;
        padding: 10px;
        width: 70%;
        margin: auto;
        font-weight: 400;
        font-size: 0.8em;
        background: #f69c2a;
    }

    #webserver-warning h1, #webserver-warning h2 {
        font-weight: 400;
    }

    #player {
        max-width: 900px;
        width: 90%;
        margin: auto;
        -webkit-box-shadow: 0px 0px 56px 0px rgba(0, 0, 0, 0.75);
        -moz-box-shadow: 0px 0px 56px 0px rgba(0, 0, 0, 0.75);
        box-shadow: 0px 0px 56px 0px rgba(0, 0, 0, 0.75);
    }

    a {
        color: #97d9ef;
        font-weight: 400;
        text-decoration: none;
    }

    a:hover {
        color: #fff;
    }

    @media (max-width: 800px) {
        .logo {
            width: 100%;
        }

        .title {
            display: none;
        }
    }
</style>

<body>
<div id="wrapper">
    <div id="banner">
        <div class="logo"><img src="../images/bitmovin-logo.png"></div>
        <div class="title"><h1>Adaptation logic in Bitmovin Player</h1></div>
        <div class="clear"></div>
    </div>
    <div class="container">
        <h1>HTML5 Adaptive Streaming Player for MPEG-DASH & HLS</h1>
        <h2>Your videos play everywhere with low startup delay, no buffering and in highest quality.</h2>
        <div class="content">
            <div class="player-wrapper">
                <div id="player"></div>
                <div id="curve_chart" style="width: 80%; height: auto" align='right'></div>
                Max Bitrate (Mbps)
                <input type="text" name="MaxBitrate" id="maxBitrate" value="5">
            </div>
            <div class="description">
                <p>For more information about the bitmovin player, please have a look at our online <a
                        href="//bitmovin.com/support" target="_blank">Developer Section</a>.</p>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
var data;
var conf;
var SEGMENT_DURATION;
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawLineChart)
      var dataset = [
          ['segmentNumber', 'Estimated throughput', 'Downloaded quality', 'Buffer Length (x10 seconds)', 'Played quality'],
          [0,  0, 0, 0, 0]
      ];
var chart;
var MAX_BITRATE;
function drawLineChart(param) {
    MAX_BITRATE = parseInt(document.getElementById('maxBitrate').value) * 1000 || Infinity;
    data = google.visualization.arrayToDataTable(dataset);
    var options = {
      title: 'Bitrate',
      curveType: 'none',
      legend: {
        position: 'top'
      },
      vAxis:{
        minValue:0,
        maxValue: MAX_BITRATE / 1000,
      'Bitrates (Mbps)' : {label: 'Bitrates (Mbps)'},
      'Buffer Length (x0.1s)' : {label: 'Buffer Length(x0.1s)'},
      },
      hAxis: {
        title: "Segment Number"
      }
    };
     chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
    chart.draw(data, options);
}
  if (location.protocol === "file:") {
    document.getElementById("webserver-warning").style.display = "block";
  }
  var availableRepresentations = 0;
var segmentNumber = 0;
    var newValue = function(metrics){
          MAX_BITRATE = parseInt(document.getElementById('maxBitrate').value) * 1000 || Infinity;
          var throughput = metrics.throughput;
          throughput = Math.min(throughput, MAX_BITRATE)
          chosenQuality = player.getDownloadedVideoData().bitrate;
          segmentNumber++;
          //segmentNumber = parseInt((player.getCurrentTime() + player.getVideoBufferLength()) /3.8);
          dataset.push([segmentNumber, throughput/1000, parseInt(chosenQuality)/1000000, null, null]);
          drawLineChart();
    }
  var conf   = {
    key   : "YourKEY",
    source: {
      dash:        "//bitmovin-a.akamaihd.net/content/MI201109210084_1/mpds/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.mpd",
      hls:         "//bitmovin-a.akamaihd.net/content/MI201109210084_1/m3u8s/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8",
      progressive: "//bitmovin-a.akamaihd.net/content/MI201109210084_1/MI201109210084_mpeg-4_hd_high_1080p25_10mbits.mp4",
      poster:      "//bitmovin-a.akamaihd.net/content/MI201109210084_1/poster.jpg"
    }
  };
  var addEvents = function() {
    player.addEventHandler('onDownloadFinished', function(data) {
      if (data.downloadType === 'media' && data.mimeType.indexOf('video') >= 0 && data.size > 1000) {
        newValue({throughput: Math.round(((data.size * 8) / data.downloadTime) / 1000)});
      }
    });
    player.addEventHandler('onSegmentPlayback', function(data) {
      SEGMENT_DURATION = data.duration;
    })
    player.addEventHandler('onTimeChanged', function(data) {
      var time = parseFloat(data.time);
      var line = parseInt(time/SEGMENT_DURATION)+1;
      dataset[line+1][4] = dataset[line+1][2];
      dataset[line+1][3] = player.getVideoBufferLength()/10;
      drawLineChart();
    });
    player.addEventHandler('onSeek', function(data) {
      if(data.position > data.seekTarget) {
      dataset = [
          ['segmentNumber', 'Estimated throughput', 'Downloaded quality', 'Buffer Length (x10 seconds)', 'Played quality'],
          [0,  0, 0, 0, 0]
      ];
      drawLineChart();
    }
    });
  }
  var segmentPlayback = [];
  var player = bitmovin.player("player");
  player.setup(conf).then(function() {
    availableRepresentations = player.getAvailableVideoQualities();
    addEvents();
  }, function(error) {
    console.log(error);
  });
</script>
